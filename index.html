<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightFeed.uk | Cardiff UAV Command</title>
    
    <!-- PWA: Status Bar & Theme Color -->
    <meta name="theme-color" content="#00BFFF">
    
    <!-- PWA: Icons (Using placeholders to ensure PWA structure is correct) -->
    <link rel="icon" type="image/png" sizes="192x192" href="https://placehold.co/192x192/00BFFF/0D1117?text=FF">
    <link rel="icon" type="image/png" sizes="512x512" href="https://placehold.co/512x512/00BFFF/0D1117?text=FF">
    <!-- Apple Touch Icon for iOS (ensures proper home screen icon) -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/00BFFF/0D1117?text=FF">

    <!-- PWA: Web App Manifest (Embedded as Data URI) -->
    <!-- short_name is set to 'FlightFeed' to ensure correct home screen naming -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRmxpZ2h0RmVlZC51ayB8IENhcmRpZmYgVVBWIENvbW1hbmQiLCJzaG9ydF9uYW1lIjoiRmxpZ2h0RmVlZCIsImRlc2NyaXB0aW9uIjoiUmVhbC10aW1lIFVBViBTdGF0dXMgYW5kIFdlYXRoZXIgRmVlZCBmb3IgQ2FyZGlmZi4iLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwRDExMTciLCJ0aGVtZV9jb2xvciI6IiMwMEJGRkYiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi8wMEJGRkYvMEQxMTE3P3RleHQ9RkYiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiJodHRwczovL3BsYWNlaG9sZC5jby81MTJ4NTEyLzAwQkZGRi8wRDExMTc/dGV4dD1GRiIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19">

    <!-- Load Tailwind CSS and Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght[300..900]&display=swap" rel="stylesheet">
    <style>
        /* Define custom Tailwind colors and configuration for the futuristic look */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'matrix-blue': '#00BFFF', /* Primary accent */
                        'neon-green': '#39FF14', /* Safe/Success */
                        'electric-yellow': '#FFD700', /* Moderate/Caution */
                        'danger-red': '#FF073A', /* Unsafe/Restricted */
                        'dark-bg': '#0D1117', /* Deep background */
                        'dark-card': '#161B22', /* Card background */
                        'dark-hover': '#21262D', /* Hover state */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Orbitron', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon-green': '0 0 8px rgba(57, 255, 20, 0.4)',
                        'neon-yellow': '0 0 8px rgba(255, 215, 0, 0.4)',
                        'neon-red': '0 0 8px rgba(255, 7, 58, 0.4)',
                        'app-focus': '0 0 15px rgba(0, 191, 255, 0.4)',
                        'prompt-pop': '0 4px 15px rgba(0, 191, 255, 0.8), 0 0 5px rgba(0, 191, 255, 0.6)', /* New Shadow for prompt */
                    }
                }
            }
        }

        /* Base styles for the app shell */
        body {
            background-color: #0D1117;
            color: #E6E8EA;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Control scrolling only in main content */
        }

        /* Styling for the fixed header */
        #app-header {
            z-index: 50;
        }

        /* Styling for the main content area to enable scrolling */
        #app-main {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-top: 1rem; /* Space below header */
            padding-bottom: 5rem; /* Space above footer */
        }

        /* Status Pill Styling - App-like, structured */
        .status-pill {
            padding: 0.35rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            line-height: 1;
            text-transform: uppercase;
        }
        
        /* Utility for the dot inside the pill */
        .status-dot-sm {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        /* Style for the app-like card */
        .app-card {
            border: 1px solid #161B22; /* Subtle border */
            transition: all 0.2s;
        }

        .app-card:hover {
            border-color: rgba(0, 191, 255, 0.4);
            box-shadow: 0 0 12px rgba(0, 191, 255, 0.2);
            background-color: #1a2028; /* Slightly lighter on hover */
        }
        
        /* Bottom Nav Bar Button Style */
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0;
            color: #4D5763;
            transition: color 0.2s;
        }
        .nav-btn.active {
            color: #00BFFF;
            text-shadow: 0 0 8px rgba(0, 191, 255, 0.5);
        }
        
        /* Page content visibility management */
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
        }
        
        /* PWA Install Prompt Styles (made it pop) */
        #install-prompt {
            position: fixed;
            bottom: 4rem; /* Above the navigation bar */
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; 
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.8), 0 0 5px rgba(0, 191, 255, 0.6); 
            display: none; /* Starts hidden, shown by JS */
        }
        #install-prompt.visible {
            opacity: 1;
        }
        
        /* iOS Share Icon SVG - Inline for clarity and style consistency */
        .share-icon-svg {
            width: 20px;
            height: 20px;
            margin-right: 4px;
            vertical-align: middle;
            display: inline-block;
        }
    </style>
</head>
<body class="font-sans">

    <!-- Fixed Header (App Bar) -->
    <header id="app-header" class="bg-dark-card p-4 border-b border-matrix-blue/40 shadow-2xl sticky top-0 z-10">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div class="text-2xl font-display font-bold text-neon-green tracking-wider">
                FLIGHTFEED<span class="text-matrix-blue">.UK</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs text-matrix-blue/70">SYNC:</span>
                <span id="system-status" class="text-neon-green font-bold text-sm">LIVE</span>
                <div class="w-2 h-2 rounded-full bg-neon-green shadow-neon-green animate-pulse"></div>
            </div>
        </div>
    </header>

    <!-- Main Scrollable Content Area -->
    <main id="app-main" class="max-w-xl mx-auto w-full px-4 sm:px-6">
        <!-- The main page content container. Only one section will be visible at a time. -->
        <div id="page-container" class="space-y-4">

            <!-- 1. ZONES PAGE (Default View) -->
            <section id="page-zones" data-page-name="Zones" class="page-content active">
                <h1 class="text-xl font-display font-light text-matrix-blue mb-4 pb-2 border-b border-matrix-blue/20">
                    Cardiff & Vale Flight Zones
                </h1>
        
                <!-- Legend / Key (Compact App Style) -->
                <div class="bg-dark-card p-3 rounded-lg mb-6 shadow-lg border border-matrix-blue/20">
                    <h2 class="text-sm font-bold text-matrix-blue mb-2">System Key:</h2>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 rounded-full bg-neon-green shadow-neon-green"></span>
                            <span class="text-neon-green font-semibold">SAFE</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 rounded-full bg-electric-yellow shadow-neon-yellow"></span>
                            <span class="text-electric-yellow font-semibold">MODERATE / CAUTION</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 rounded-full bg-danger-red shadow-neon-red"></span>
                            <span class="text-danger-red font-semibold">UNSAFE / RESTRICTED</span>
                        </div>
                    </div>
                </div>
        
                <!-- Location Cards Container (Populated by JS) -->
                <section id="location-container" class="space-y-4"></section>
            </section>

            <!-- 2. FORECAST PAGE -->
            <section id="page-forecast" data-page-name="Forecast" class="page-content">
                <h1 class="text-xl font-display font-light text-matrix-blue mb-4 pb-2 border-b border-matrix-blue/20">
                    UAV 7-Day Flight Forecast
                </h1>
                <p class="text-sm text-gray-400 mb-6">Real-time aviation weather data for the Cardiff region.</p>
                
                <section id="forecast-details-container" class="space-y-4"></section>
            </section>

            <!-- 3. ALERTS PAGE -->
            <section id="page-alerts" data-page-name="Alerts" class="page-content">
                <h1 class="text-xl font-display font-light text-matrix-blue mb-4 pb-2 border-b border-matrix-blue/20">
                    Active Flight Advisories & Warnings
                </h1>
                <p class="text-sm text-gray-400 mb-6">Essential NOTAMs and system warnings affecting local airspace.</p>

                <section id="alerts-container" class="space-y-4"></section>
            </section>

        </div>
    </main>
    
    <!-- iOS PWA INSTALL INSTRUCTIONS POPUP -->
    <div id="install-prompt" class="bg-matrix-blue/95 text-dark-bg p-3 rounded-xl shadow-prompt-pop">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold text-sm">Install FlightFeed App (iOS)</span>
            <button id="close-prompt" class="text-lg font-bold p-1 leading-none hover:text-danger-red/80 transition duration-150">
                &times;
            </button>
        </div>
        <p class="text-xs font-semibold">
            To install: Tap the 
            <!-- Share Icon SVG (Up Arrow from Box) -->
            <svg class="share-icon-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
            <span class="font-bold">Share icon</span>, then select **'Add to Home Screen'**.
        </p>
    </div>

    <!-- Fixed Bottom Navigation Bar (App Footer) -->
    <footer class="fixed bottom-0 w-full bg-dark-card border-t border-matrix-blue/40 z-50">
        <div class="max-w-xl mx-auto flex justify-around items-center h-14 text-xs font-medium">
            <a href="#" id="nav-zones" data-page="Zones" class="nav-btn active">
                <!-- Map Pin Icon SVG (lucide) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M12 21.75l-4.5-5.5a7 7 0 1 1 9 0l-4.5 5.5z"/><circle cx="12" cy="10" r="3"/></svg>
                <span class="mt-1">Zones</span>
            </a>
            <a href="#" id="nav-forecast" data-page="Forecast" class="nav-btn">
                <!-- Gauge Icon SVG (lucide) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gauge"><path d="M12 14v4"/><path d="M15.5 16.5l2.5 2.5"/><path d="M8.5 16.5l-2.5 2.5"/><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/><path d="M12 12c-3.3 0-6-2.7-6-6"/></svg>
                <span class="mt-1">Forecast</span>
            </a>
            <a href="#" id="nav-alerts" data-page="Alerts" class="nav-btn">
                <!-- Alert/Bell Icon SVG (lucide) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                <span class="mt-1">Alerts</span>
            </a>
        </div>
    </footer>


<script>
    // --- MOCK DATA SETS ---

    // EXPANDED LOCATION DATA: Now includes 30 locations for better regional coverage
    const locationData = [
        // Original 7 locations
        { id: 1, name: "Cardiff Bay Barrage", area: "Cardiff Bay", coords: "51.45N, -3.16W", wind_speed: 15, nfz_status: 'CAUTION', notes: "Wind is often higher near the coast. Requires awareness of local Port Authority / Bay Byelaws." },
        { id: 2, name: "Trellai Park", area: "Llanrumney", coords: "51.50N, -3.12W", wind_speed: 8, nfz_status: 'OPEN', notes: "Good open space. Standard Drone Code applies (VLOS, 400ft max)." },
        { id: 5, name: "Cardiff Airport FRZ", area: "Rhoose (Warning)", coords: "51.39N, -3.34W", wind_speed: 16, nfz_status: 'RESTRICTED', notes: "STRICT NO-FLY ZONE. Within Flight Restriction Zone (FRZ). Do NOT attempt flight." },
        { id: 11, name: "Penarth Pier Head", area: "Penarth Coast", coords: "51.43N, -3.16W", wind_speed: 21, nfz_status: 'CAUTION', notes: "EXTREME WIND WARNING (21 mph)! Unsafe for most consumer drones. Strong sea breeze expected. High chance of salt spray." },
        { id: 29, name: "Ogmore-by-Sea", area: "Bridgend Coast (Vale)", coords: "51.46N, -3.61W", wind_speed: 18, nfz_status: 'CAUTION', notes: "Strong sea winds (18 mph). Suitable for experienced pilots only. Watch tide line." },
        { id: 33, name: "Cardiff Central Train Station", area: "City Centre", coords: "51.47N, -3.18W", wind_speed: 8, nfz_status: 'RESTRICTED', notes: "Critical transport infrastructure. Rail and high public risk. **Do NOT fly** without explicit Network Rail/Police permission." },
        { id: 35, name: "Roath Park Lake", area: "Roath", coords: "51.49N, -3.15W", wind_speed: 9, nfz_status: 'OPEN', notes: "Open park, but requires care due to water and wildlife. Keep clear of children's play areas." },
        
        // 23 New Locations Added
        { id: 40, name: "Bute Park South", area: "City Centre Fringe", coords: "51.48N, -3.18W", wind_speed: 7, nfz_status: 'CAUTION', notes: "High pedestrian volume, especially weekends. Maintain 50m separation from people/buildings." },
        { id: 41, name: "Garth Mountain Summit", area: "Taff's Well", coords: "51.54N, -3.27W", wind_speed: 25, nfz_status: 'CAUTION', notes: "SEVERE WIND WARNING (25 mph)! High altitude, turbulent air. Not recommended for non-pro gear." },
        { id: 42, name: "Llandaff Cathedral Area", area: "Llandaff", coords: "51.49N, -3.22W", wind_speed: 6, nfz_status: 'RESTRICTED', notes: "Historic structure protection zone. Permission from site management is mandatory." },
        { id: 43, name: "St. Fagans Museum", area: "St. Fagans", coords: "51.48N, -3.28W", wind_speed: 10, nfz_status: 'RESTRICTED', notes: "No overflight permitted due to protected buildings and visitor safety regulations." },
        { id: 44, name: "Sully Island Coast", area: "Sully", coords: "51.40N, -3.20W", wind_speed: 17, nfz_status: 'CAUTION', notes: "Tidal movements are rapid. Launch/Recovery must be planned around the tide. High winds." },
        { id: 45, name: "Newport Wetlands Reserve", area: "Newport", coords: "51.55N, -2.96W", wind_speed: 12, nfz_status: 'RESTRICTED', notes: "RSPB Nature Reserve. STRICTLY NO FLYING due to wildlife disturbance." },
        { id: 46, name: "Taff Trail (Radyr)", area: "Northern Cardiff", coords: "51.52N, -3.22W", wind_speed: 5, nfz_status: 'CAUTION', notes: "Linear path next to private land and river. Maintain low altitude and respect privacy." },
        { id: 47, name: "Porthcawl Seafront", area: "Porthcawl", coords: "51.48N, -3.71W", wind_speed: 19, nfz_status: 'CAUTION', notes: "Gale-force gusts (19 mph). Only heavy, professional rigs should be flown." },
        { id: 48, name: "Barry Island Pleasure Park", area: "Barry", coords: "51.39N, -3.28W", wind_speed: 14, nfz_status: 'RESTRICTED', notes: "High public density and major attraction. Do not fly over crowds or rides." },
        { id: 49, name: "Caerphilly Castle", area: "Caerphilly", coords: "51.57N, -3.22W", wind_speed: 9, nfz_status: 'RESTRICTED', notes: "Protected historical site. CAA Article 241 rules apply. Permission needed." },
        { id: 50, name: "Tredegar Park", area: "Newport", coords: "51.57N, -3.05W", wind_speed: 7, nfz_status: 'OPEN', notes: "Large open park suitable for recreational flying. Check for local events." },
        { id: 51, name: "Pontcanna Fields", area: "Cardiff", coords: "51.48N, -3.20W", wind_speed: 11, nfz_status: 'CAUTION', notes: "Often used for sports and grazing. Monitor for horses and sporting events." },
        { id: 52, name: "Ely Bridge Junction", area: "Western Cardiff", coords: "51.47N, -3.25W", wind_speed: 13, nfz_status: 'RESTRICTED', notes: "Proximity to high-speed road (A4232). High risk of distracted driving. AVOID." },
        { id: 53, name: "HMS Cambria Reserve", area: "Sully (Military)", coords: "51.41N, -3.17W", wind_speed: 16, nfz_status: 'RESTRICTED', notes: "Military airspace/establishment. Immediate grounding and police report if observed flying." },
        { id: 54, name: "Heath Park", area: "Cardiff", coords: "51.51N, -3.18W", wind_speed: 4, nfz_status: 'OPEN', notes: "Low wind, excellent conditions. Avoid hospital heli-route nearby." },
        { id: 55, name: "Blackwood Showground", area: "Blackwood", coords: "51.64N, -3.17W", wind_speed: 10, nfz_status: 'OPEN', notes: "Large, unobstructed area. Ideal for testing and training." },
        { id: 56, name: "Brecon Beacons National Park", area: "Storey Arms", coords: "51.88N, -3.45W", wind_speed: 20, nfz_status: 'CAUTION', notes: "High altitude flight requires specialist batteries. Strong, sudden mountain winds (20 mph)." },
        { id: 57, name: "Bristol Channel (Near Tunnel)", area: "Seven Estuary", coords: "51.52N, -2.70W", wind_speed: 18, nfz_status: 'RESTRICTED', notes: "Major transport and national border infrastructure. High-risk zone." },
        { id: 58, name: "M4 Corridor", area: "J33 Area", coords: "51.49N, -3.32W", wind_speed: 15, nfz_status: 'CAUTION', notes: "Proximity to motorway. Maintain height below 50ft when near the road boundary." },
        { id: 59, name: "Castell Coch", area: "Tongwynlais", coords: "51.53N, -3.23W", wind_speed: 11, nfz_status: 'CAUTION', notes: "Wooded hill area, potential for high wind shear and RF interference. Permission advised." },
        { id: 60, name: "Flat Holm Island", area: "Bristol Channel", coords: "51.37N, -3.12W", wind_speed: 18, nfz_status: 'RESTRICTED', notes: "Protected Nature Reserve. Absolute ban on drone flight over the island." },
        { id: 61, name: "The Hayes Shopping Area", area: "Cardiff City Centre", coords: "51.48N, -3.17W", wind_speed: 3, nfz_status: 'RESTRICTED', notes: "High concentration of people and buildings. Requires specific GVC/Operational Authorisation." },
        { id: 62, name: "Talybont Reservoir", area: "Brecon Beacons", coords: "51.88N, -3.30W", wind_speed: 12, nfz_status: 'OPEN', notes: "Remote location, great views. Be aware of private water utility land." },
        { id: 63, name: "Parc Penallta", area: "Hengoed", coords: "51.65N, -3.24W", wind_speed: 7, nfz_status: 'OPEN', notes: "Former colliery site, now parkland. Low risk, clear visibility." },
    ];

    const forecastData = [
        { day: 'MON (TODAY)', wind_speed: 15, gust_speed: 24, temp: 12, visibility: 'GOOD', rain: 10 },
        { day: 'TUE', wind_speed: 8, gust_speed: 12, temp: 14, visibility: 'EXCELLENT', rain: 0 },
        { day: 'WED', wind_speed: 6, gust_speed: 9, temp: 15, visibility: 'EXCELLENT', rain: 0 },
        { day: 'THU', wind_speed: 18, gust_speed: 30, temp: 11, visibility: 'GOOD', rain: 75 },
        { day: 'FRI', wind_speed: 10, gust_speed: 15, temp: 13, visibility: 'MODERATE', rain: 50 },
        { day: 'SAT', wind_speed: 12, gust_speed: 19, temp: 14, visibility: 'GOOD', rain: 20 },
        { day: 'SUN', wind_speed: 14, gust_speed: 22, temp: 12, visibility: 'MODERATE', rain: 0 },
    ];

    const alertData = [
        {
            id: 1,
            type: 'TEMPORARY FLIGHT RESTRICTION',
            area: 'CARDIFF BAY CENTRE',
            priority: 'HIGH',
            details: 'Public event (Regatta) from 09:00 to 18:00 on Nov 4th. TFR applies to all UAS up to 400ft AGL within 0.5nm radius.',
            date: '2025-11-04'
        },
        {
            id: 4,
            type: 'MANDATORY FRZ CHECK',
            area: 'CARDIFF AIRPORT',
            priority: 'CRITICAL',
            details: 'The Airport FRZ boundary has been adjusted. ALL flight plans near Rhoose must be re-validated with the new map data.',
            date: '2025-11-03'
        }
    ];

    // --- UTILITIES ---

    function getUAVForecast(windSpeed) {
        if (windSpeed >= 19) { 
            return {
                status: 'UNSAFE',
                color: 'text-danger-red',
                shadow: 'shadow-neon-red',
                bgColor: 'bg-danger-red/20',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wind"><path d="M17.74 3.34a7 7 0 0 0-11.48 4"/><path d="M2.57 14.5a6 6 0 0 1 11.85-2.22"/><path d="M4.68 8.61a5 5 0 0 1 8.87 2.03"/><path d="M12 21v-8"/></svg>'
            };
        } else if (windSpeed >= 13) {
            return {
                status: 'MODERATE',
                color: 'text-electric-yellow',
                shadow: 'shadow-neon-yellow',
                bgColor: 'bg-electric-yellow/20',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-wind"><path d="M12.55 18a2 2 0 0 1-1.39-2"/><path d="M16 16.2a2 2 0 0 1-3.2-.2"/><path d="M6 18H4a2 2 0 0 1-2-2"/><path d="M14.58 4.09A5.8 5.8 0 0 0 13 4c-2.48 0-4.7 1.15-6.13 2.91a2 2 0 0 0-2.11.19A3.5 3.5 0 0 0 5 13h10a4 4 0 0 0 0-8.5"/><path d="M22 17H10"/></svg>'
            };
        } else {
            return {
                status: 'SAFE',
                color: 'text-neon-green',
                shadow: 'shadow-neon-green',
                bgColor: 'bg-neon-green/20',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun-medium"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/></svg>'
            };
        }
    }

    function getNFZStyle(status) {
        if (status === 'RESTRICTED') {
            return {
                statusText: 'NO-FLY ZONE',
                color: 'text-danger-red',
                shadow: 'shadow-neon-red',
                bgColor: 'bg-danger-red/20',
                dotColor: 'bg-danger-red',
            };
        } else if (status === 'CAUTION') {
            return {
                statusText: 'CAUTION: PERMIT/RULES',
                color: 'text-electric-yellow',
                shadow: 'shadow-neon-yellow',
                bgColor: 'bg-electric-yellow/20',
                dotColor: 'bg-electric-yellow',
            };
        } else {
            return {
                statusText: 'OPEN ZONE',
                color: 'text-neon-green',
                shadow: 'shadow-neon-green',
                bgColor: 'bg-neon-green/20',
                dotColor: 'bg-neon-green',
            };
        }
    }
    
    function getRainIcon(rainChance) {
        let iconColor = 'text-gray-400';
        let icon;

        if (rainChance >= 60) {
            iconColor = 'text-matrix-blue';
            icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-rain ${iconColor}"><line x1="16" x2="16" y1="13" y2="13.01"/><line x1="8" x2="8" y1="13" y2="13.01"/><line x1="12" x2="12" y1="21" y2="21.01"/><path d="M12 15V9"/><path d="M2 13h2"/><path d="M20 13h2"/><path d="M17.5 12.8a7 7 0 1 0-8.5-8.5 4 4 0 0 0 0 7"/></svg>`;
        } else if (rainChance >= 20) {
            iconColor = 'text-matrix-blue/80';
            icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-drizzle ${iconColor}"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.35"/><line x1="16" x2="16" y1="17" y2="21"/><line x1="8" x2="8" y1="17" y2="21"/><line x1="12" x2="12" y1="19" y2="23"/></svg>`;
        } else {
            iconColor = 'text-neon-green/80';
            icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun ${iconColor}"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
        }

        return `<div class="flex items-center space-x-1 font-semibold text-xs">${icon}<span>${rainChance}%</span></div>`;
    }

    // --- PAGE RENDERING FUNCTIONS (Partial to keep file size down) ---

    function renderZonesPage() {
        const container = document.getElementById('location-container');
        if (!container) return;
        container.innerHTML = ''; 

        // Sort locations alphabetically by name before rendering
        const sortedLocations = locationData.sort((a, b) => a.name.localeCompare(b.name));

        sortedLocations.forEach(location => {
            const forecast = getUAVForecast(location.wind_speed);
            const nfzStyle = getNFZStyle(location.nfz_status);

            const advisoryColor = nfzStyle.color.replace('text-', 'text-') + (location.nfz_status === 'RESTRICTED' ? ' font-bold' : '/90');

            const html = `
                <div class="app-card bg-dark-card p-4 rounded-xl shadow-xl">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00BFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M12 21.75l-4.5-5.5a7 7 0 1 1 9 0l-4.5 5.5z"/><circle cx="12" cy="10" r="3"/></svg>
                            <div>
                                <h2 class="text-lg font-bold text-white font-display">${location.name}</h2>
                                <p class="text-xs text-matrix-blue/70 -mt-0.5">${location.area} [${location.coords}]</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-matrix-blue/10">
                        <div>
                            <p class="text-xs text-matrix-blue/70 mb-1 font-semibold flex items-center">UAV FORECAST</p>
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl font-display ${forecast.color}">
                                    ${location.wind_speed}<span class="text-sm font-sans ml-1">mph</span>
                                </span>
                                <span class="status-pill ${forecast.bgColor} ${forecast.color} font-bold ring-1 ring-current">
                                    ${forecast.status}
                                </span>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs ${nfzStyle.color} mb-1 font-semibold flex items-center">NFZ STATUS</p>
                            <span class="status-pill ${nfzStyle.bgColor} ${nfzStyle.color} ring-1 ring-current font-bold">
                                <span class="status-dot-sm inline-block ${nfzStyle.dotColor}"></span>
                                ${nfzStyle.statusText}
                            </span>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-t border-matrix-blue/10">
                        <p class="text-xs font-bold ${nfzStyle.color} mb-1">ADVISORY:</p>
                        <p class="text-sm italic ${advisoryColor}">
                            ${location.notes}
                        </p>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderForecastPage() {
        const container = document.getElementById('forecast-details-container');
        if (!container) return;
        container.innerHTML = '';

        const overview = forecastData[0];
        const currentForecast = getUAVForecast(overview.wind_speed);
        let overviewHTML = `
            <div class="app-card bg-dark-card p-5 rounded-xl shadow-2xl border-matrix-blue/40">
                <h2 class="text-lg font-display text-matrix-blue mb-3">CURRENT CONDITIONS</h2>
                <div class="flex items-center justify-between">
                    <div class="flex items-end">
                        <span class="text-5xl font-display font-light ${currentForecast.color}">${overview.temp}&deg;C</span>
                        <span class="text-lg text-gray-500 ml-2">(${overview.wind_speed}mph)</span>
                    </div>
                    ${currentForecast.icon}
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4 text-sm">
                    <p class="text-matrix-blue/80"><span class="font-bold">FLIGHT RATING:</span> <span class="font-display font-semibold ${currentForecast.color}">${currentForecast.status}</span></p>
                    <p class="text-matrix-blue/80"><span class="font-bold">GUSTS:</span> <span class="text-white">${overview.gust_speed} mph</span></p>
                    <p class="text-matrix-blue/80"><span class="font-bold">VISIBILITY:</span> <span class="text-white">${overview.visibility}</span></p>
                    <p class="text-matrix-blue/80"><span class="font-bold">RAIN RISK:</span> <span class="text-white">${overview.rain}%</span></p>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', overviewHTML);

        let detailedHTML = `<div class="space-y-2"><h2 class="text-lg font-display text-matrix-blue pt-4">UPCOMING DAYS</h2>`;
        detailedHTML += `
            <div class="flex justify-between items-center text-xs font-semibold text-matrix-blue/70 uppercase border-b border-matrix-blue/20 pb-2 mb-2">
                <span class="w-1/4">Day</span>
                <span class="w-1/4 text-center">Wind (mph)</span>
                <span class="w-1/4 text-center">Temp / Rain</span>
                <span class="w-1/4 text-right">Rating</span>
            </div>
        `;

        forecastData.forEach(dayForecast => {
            const f = getUAVForecast(dayForecast.wind_speed);
            const rainIconHtml = getRainIcon(dayForecast.rain);
            const bgColor = dayForecast.day.includes('TODAY') ? 'bg-dark-hover' : 'bg-dark-card';
            
            detailedHTML += `
                <div class="flex justify-between items-center ${bgColor} p-3 rounded-lg border border-matrix-blue/10 hover:border-matrix-blue/40 transition duration-150">
                    <span class="font-bold w-1/4 ${dayForecast.day.includes('TODAY') ? 'text-white' : 'text-matrix-blue/80'}">${dayForecast.day}</span>
                    <span class="w-1/4 text-center text-sm font-semibold ${f.color}">${dayForecast.wind_speed}</span>
                    <span class="w-1/4 text-center text-sm text-gray-300 flex justify-center items-center space-x-2">
                        <span>${dayForecast.temp}&deg;C</span>
                        ${rainIconHtml}
                    </span>
                    <span class="w-1/4 text-right status-pill ${f.bgColor} ${f.color} ring-1 ring-current">${f.status}</span>
                </div>
            `;
        });
        detailedHTML += `</div>`;
        container.insertAdjacentHTML('beforeend', detailedHTML);
    }

    function renderAlertsPage() {
        const container = document.getElementById('alerts-container');
        if (!container) return;
        container.innerHTML = '';

        alertData.forEach(alert => {
            let priorityStyle, icon;

            switch (alert.priority) {
                case 'CRITICAL':
                    priorityStyle = 'border-danger-red shadow-neon-red/50';
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap-off text-danger-red"><polyline points="12.43 21 19 14 18.57 10.5"/><line x1="18" x2="22" y1="4" y2="8"/><line x1="2" x2="6" y1="16" y2="20"/><path d="M10.56 12.56L10 12l-6 8h12l-.78-1.28"/></svg>';
                    break;
                case 'HIGH':
                    priorityStyle = 'border-electric-yellow shadow-neon-yellow/50';
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle text-electric-yellow"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>';
                    break;
                case 'MEDIUM':
                    priorityStyle = 'border-matrix-blue shadow-app-focus/50';
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info text-matrix-blue"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>';
                    break;
                default: // LOW
                    priorityStyle = 'border-neon-green shadow-neon-green/50';
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle text-neon-green"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg>';
                    break;
            }

            const html = `
                <div class="app-card bg-dark-card p-4 rounded-xl shadow-lg border-l-4 ${priorityStyle}">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center space-x-3">
                            ${icon}
                            <div>
                                <h3 class="text-base font-bold text-white">${alert.type}</h3>
                                <p class="text-xs text-matrix-blue/70 -mt-0.5 font-display">${alert.area} / ${alert.date}</p>
                            </div>
                        </div>
                        <span class="status-pill text-xs font-bold ring-1 ring-current ${alert.priority === 'CRITICAL' ? 'bg-danger-red/20 text-danger-red' : alert.priority === 'HIGH' ? 'bg-electric-yellow/20 text-electric-yellow' : 'bg-matrix-blue/20 text-matrix-blue'}">
                            ${alert.priority}
                        </span>
                    </div>
                    <p class="text-sm text-gray-400 mt-3 pt-3 border-t border-matrix-blue/10 italic">
                        ${alert.details}
                    </p>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });

        if (alertData.length === 0) {
            container.innerHTML = `<div class="text-center p-8 text-gray-500 bg-dark-card rounded-xl border border-neon-green/30">
                <p class="text-lg">No Critical Advisories Active.</p>
                <p class="text-sm mt-1">Local airspace is clear. Always check local zone requirements.</p>
            </div>`;
        }
    }

    // --- PAGE CONTROL LOGIC ---

    let currentPage = 'Zones';

    function changePage(pageName) {
        if (currentPage === pageName) return;

        currentPage = pageName;

        document.querySelectorAll('.page-content').forEach(section => {
            if (section.getAttribute('data-page-name') === pageName) {
                section.classList.add('active');
            } else {
                section.classList.remove('active');
            }
        });

        document.querySelectorAll('.nav-btn').forEach(btn => {
            if (btn.getAttribute('data-page') === pageName) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        const mainContent = document.getElementById('app-main');
        mainContent.scrollTop = 0; 

        switch (pageName) {
            case 'Zones':
                renderZonesPage();
                break;
            case 'Forecast':
                renderForecastPage();
                break;
            case 'Alerts':
                renderAlertsPage();
                break;
        }
    }


    // --- PWA INSTALL PROMPT LOGIC ---

    function showInstallPrompt() {
        const installPrompt = document.getElementById('install-prompt');
        // Check for iOS (based on user agent) and if the app is NOT running standalone
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone;

        // Only show if it's likely iOS and the app is NOT already installed
        if (isIOS && !isStandalone) {
            installPrompt.style.display = 'block'; // Ensure it's rendered
            
            // Use a slight delay to trigger the opacity transition, making it "pop"
            setTimeout(() => {
                installPrompt.classList.add('visible');
            }, 50); 

            // Add dismiss listener
            document.getElementById('close-prompt').addEventListener('click', () => {
                installPrompt.classList.remove('visible');
                // Hide completely after fade out
                setTimeout(() => {
                    installPrompt.style.display = 'none';
                }, 300); 
            });
        } else {
            // Hide the prompt container if conditions aren't met
            installPrompt.style.display = 'none';
        }
    }


    // --- INITIALIZATION ---

    window.onload = function() {
        // --- 1. Navigation Setup ---
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                const page = button.getAttribute('data-page');
                changePage(page);
            });
        });

        // --- 2. Render and Show Prompt ---
        renderZonesPage();
        showInstallPrompt();
    };
</script>
</body>
